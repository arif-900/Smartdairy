{% extends "layout.html" %}
{% block title %}Dashboard ‚Ä¢ SmartDairy{% endblock %}

{% block content %}

<!-- Page Heading -->
<div class="space-y-1 mb-4">
  <h1 class="text-xl font-semibold text-slate-800 tracking-tight">Dashboard Overview</h1>
  <p class="text-xs text-slate-500">
    Quick snapshot of your dairy farm activity & monthly performance.
  </p>
</div>

<!-- Salary Due Notification (supports partial + full due) -->
{% if due_count > 0 %}
  <div class="mb-4 bg-red-50 border border-red-200 text-xs text-red-800 rounded-xl px-3 py-2 flex flex-col gap-1 card-hover">
    <div class="flex items-center justify-between gap-2">
      <div class="flex items-center gap-2">
        <span>‚ö†Ô∏è</span>
        <p class="font-semibold">
          {{ due_count }} worker{{ 's' if due_count > 1 }} have pending salary for {{ month_label }}.
        </p>
      </div>
      <a href="{{ url_for('salary_add') }}"
         class="text-[11px] text-red-700 underline">
        + Record salary payment
      </a>
    </div>

    <div class="text-[11px] text-red-700 mt-1 space-y-1">
      {% for item in due_workers %}
        {% set w = item.worker %}
        {% set paid = item.paid %}
        {% set expected = item.expected %}
        {% set due = item.due %}

        <div class="pt-1 mt-1 border-t border-red-100 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-1">
          <div>
            <strong>W-{{ w.id }}</strong> ‚Ä¢ {{ w.name }}
            {% if w.mobile %} ({{ w.mobile }}){% endif %}
            {% if paid > 0 %}
              <span class="ml-2 text-[10px] uppercase tracking-wide bg-yellow-100 border border-yellow-200 text-yellow-800 rounded-full px-1.5 py-0.5">
                Partially Paid
              </span>
            {% else %}
              <span class="ml-2 text-[10px] uppercase tracking-wide bg-red-100 border border-red-200 text-red-800 rounded-full px-1.5 py-0.5">
                Not Paid
              </span>
            {% endif %}
          </div>
          <div class="flex flex-wrap gap-2 text-[11px] sm:text-right">
            <span>Expected: <strong>‚Çπ {{ "{:,}".format(expected) }}</strong></span>
            <span>Paid: <strong>‚Çπ {{ "{:,}".format(paid) }}</strong></span>
            <span>Due: <strong>‚Çπ {{ "{:,}".format(due) }}</strong></span>
          </div>
        </div>
      {% endfor %}
    </div>
  </div>
{% else %}
  <div class="mb-4 bg-emerald-50 border border-emerald-200 text-xs text-emerald-800 rounded-xl px-3 py-2 flex items-center justify-between card-hover">
    <div class="flex items-center gap-2">
      <span>‚úÖ</span>
      <p class="font-medium">
        All active workers are fully paid for {{ month_label }}.
      </p>
    </div>
    <a href="{{ url_for('salary_list') }}" class="text-[11px] underline">
      View salary history
    </a>
  </div>
{% endif %}

<!-- Low Milk Alerts Card -->
<div class="rounded-xl border border-amber-200 bg-amber-50 px-4 py-3 text-xs">
  <div class="flex items-center justify-between mb-1">
    <span class="font-medium text-amber-800">Low Milk Alerts (Today)</span>
    <span class="text-[11px] font-semibold text-amber-700">
      {{ low_milk_count }}
    </span>
  </div>
  {% if low_milk_alerts %}
    <ul class="space-y-1 max-h-32 overflow-y-auto">
      {% for a in low_milk_alerts %}
        <li class="flex items-start justify-between gap-2">
          <div>
            <div class="font-medium text-amber-800">
              B-{{ a.buffalo.id }} ‚Ä¢ {{ a.buffalo.tag_name }}
            </div>
            <div class="text-[10px] text-amber-700">
              Today: {{ "%.2f"|format(a.today_total) }} L,
              Avg: {{ "%.2f"|format(a.avg_total) }} L
            </div>
          </div>
        </li>
      {% endfor %}
    </ul>
  {% else %}
    <p class="text-[11px] text-amber-700 mt-1">
      No low-milk alerts today.
    </p>
  {% endif %}
</div>


<!-- Stats Grid -->
<div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">

  <!-- Total Buffaloes -->
  <div class="bg-white border border-slate-200 rounded-xl p-4 shadow-sm card-hover space-y-2">
    <div class="text-slate-500 text-xs flex items-center gap-2">
      üêÉ Total Buffaloes
    </div>
    <div class="text-2xl font-semibold text-slate-800">
      {{ total_buffaloes }}
    </div>
    <p class="text-[11px] text-slate-500">All animals currently recorded</p>
  </div>

  <!-- Active Buffaloes -->
  <div class="bg-white border border-slate-200 rounded-xl p-4 shadow-sm card-hover space-y-2">
    <div class="text-slate-500 text-xs flex items-center gap-2">
      ‚úÖ Active Buffaloes
    </div>
    <div class="text-2xl font-semibold text-emerald-700">
      {{ active_buffaloes }}
    </div>
    <p class="text-[11px] text-slate-500">Available & healthy animals</p>
  </div>

  <!-- Workers -->
  <div class="bg-white border border-slate-200 rounded-xl p-4 shadow-sm card-hover space-y-2">
    <div class="text-slate-500 text-xs flex items-center gap-2">
      üë∑ Total Workers
    </div>
    <div class="text-2xl font-semibold text-slate-800">
      {{ total_workers }}
    </div>
    <p class="text-[11px] text-slate-500">Active + past workers tracked</p>
  </div>

  <!-- Active Workers -->
  <div class="bg-white border border-slate-200 rounded-xl p-4 shadow-sm card-hover space-y-2">
    <div class="text-slate-500 text-xs flex items-center gap-2">
      üíº Active Workers
    </div>
    <div class="text-2xl font-semibold text-emerald-700">
      {{ active_workers }}
    </div>
    <p class="text-[11px] text-slate-500">Currently working at your dairy</p>
  </div>

</div>

<!-- Monthly Summary Header -->
<div class="mt-6">
  <h2 class="text-sm font-semibold text-slate-700 mb-2">
    Monthly Summary ‚Äî {{ month_label }}
  </h2>
</div>

<!-- Monthly Summary Card -->
<div class="grid grid-cols-1 md:grid-cols-3 gap-4">

  <!-- Salary Cost -->
  <div class="bg-white border border-slate-200 rounded-xl p-4 shadow-sm card-hover">
    <p class="text-slate-500 text-xs">üí∏ Salary Expenses</p>
    <p class="text-xl font-semibold text-slate-800 mt-1">
      ‚Çπ {{ "{:,}".format(month_salary_total or 0) }}
    </p>
    <p class="text-[11px] text-slate-500 mt-1">Total salaries paid this month</p>
  </div>

  <!-- Other Expenses -->
  <div class="bg-white border border-slate-200 rounded-xl p-4 shadow-sm card-hover">
    <p class="text-slate-500 text-xs">üìâ Farm Expenses</p>
    <p class="text-xl font-semibold text-slate-800 mt-1">
      ‚Çπ {{ "{:,}".format(month_expense_total or 0) }}
    </p>
    <p class="text-[11px] text-slate-500 mt-1">Feed, medicine, electricity, etc.</p>
  </div>

  <!-- Total Monthly Cost -->
  <div class="bg-white border border-slate-200 rounded-xl p-4 shadow-sm card-hover">
    <p class="text-slate-500 text-xs">üì¶ Total Monthly Cost</p>
    <p class="text-2xl font-semibold text-emerald-700 mt-1">
      ‚Çπ {{ "{:,}".format(month_total_cost or 0) }}
    </p>
    <p class="text-[11px] text-slate-500 mt-1">Total operating cost for this month</p>
  </div>

  <!-- Today Milk Total -->
<div class="rounded-xl border border-slate-200 bg-white px-4 py-3 text-xs">
  <div class="text-[11px] text-slate-500 mb-1">Today‚Äôs Milk (All)</div>
  <div class="text-lg font-semibold text-slate-800">
    {{ "%.2f"|format(today_milk_total or 0) }} L
  </div>
</div>

<!-- Month Milk Total -->
<div class="rounded-xl border border-slate-200 bg-white px-4 py-3 text-xs">
  <div class="text-[11px] text-slate-500 mb-1">This Month‚Äôs Milk (All)</div>
  <div class="text-lg font-semibold text-slate-800">
    {{ "%.2f"|format(month_milk_total or 0) }} L
  </div>
</div>
</div>

<!-- Suggestion Card -->
<div class="mt-6">
  <div class="bg-white border border-slate-200 rounded-xl p-4 shadow-sm card-hover">
    <h3 class="text-sm font-semibold text-slate-700 mb-1">üìå Tips for better accuracy</h3>
    <ul class="list-disc pl-5 text-[11px] text-slate-600 space-y-1">
      <li>When you pay partial salary, add it as a new salary payment entry.</li>
      <li>Use this dashboard to see how much is still due for each worker.</li>
      <li>Record feed, medicine & maintenance expenses regularly.</li>
      <li>Use filters in tables to quickly find past records.</li>
    </ul>
  </div>
</div>

{% endblock %}
